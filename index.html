<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TNAA Sandbox">
    <link rel="manifest" href="manifest.json">
    
    <title>TNAA Sandbox Pro</title>
    <style>
        /* --- è§†è§‰é£æ ¼ä¸å…¨å±å¸ƒå±€ä¿®å¤ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0; 
            width: 100vw; 
            height: 100dvh; /* ä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ï¼Œè§£å†³ iOS ç•™ç™½é—®é¢˜ */
            background-color: #000; color: #fff;
            font-family: -apple-system, "SF Mono", "Menlo", monospace;
            overflow: hidden; 
            position: fixed; /* é’‰æ­»å¤–å±‚ï¼Œé˜²æ­¢å¹²æ‰°æ»šåŠ¨ */
        }

        #app-ui { 
            display: flex; flex-direction: column; 
            position: absolute;
            inset: 0; /* å¼ºåˆ¶æ‹‰ä¼¸åˆ°ç‰©ç†è¾¹ç•Œ */
            padding-top: env(safe-area-inset-top); 
            padding-bottom: env(safe-area-inset-bottom); /* å…³é”®ï¼šç¡®ä¿åº•éƒ¨å†…å®¹ä¸è¢«æŒ¡ä½ */
        }

        .header { 
            padding: 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #222; background: #000;
        }
        .header h1 { margin: 0; font-size: 18px; letter-spacing: 2px; color: #0f0; transition: color 0.3s; }
        
        .btn-new { 
            background: #0f0; color: #000; border: none; padding: 8px 16px; 
            border-radius: 4px; font-weight: 900; font-size: 12px; 
        }
        .btn-new:disabled { background: #333; color: #666; }

        #file-list { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 20px; /* ç»™åˆ—è¡¨åº•éƒ¨ç•™ä¸€ç‚¹å‘¼å¸ç©ºé—´ */
        }
        .file-row { padding: 18px 20px; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; }
        .file-row:active { background: #111; }
        .file-name { font-size: 16px; color: #ccc; flex: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        .file-actions { display: flex; gap: 8px; }
        .file-actions button { background: #111; border: 1px solid #333; color: #888; padding: 5px 10px; border-radius: 4px; font-size: 11px; }
        .btn-del { color: #ff3b30 !important; }

        /* ç¼–è¾‘å™¨å±‚ */
        #editor-layer { 
            display: none; position: fixed; inset: 0; background: #000; z-index: 50; 
            flex-direction: column; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .editor-bar { padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #222; }
        .btn-text { background: none; border: none; color: #0f0; font-weight: bold; font-size: 15px; padding: 5px; }
        .btn-text:disabled { color: #333; }
        .btn-cancel { color: #ff3b30; }
        
        textarea#code-area {
            flex: 1; width: 100%; border: none; background: #050505; color: #0f0;
            padding: 15px; font-family: "SF Mono", Menlo, monospace;
            font-size: 14px; line-height: 1.5; outline: none; resize: none;
        }

        /* è¿è¡Œå±‚é¢„è§ˆ */
        #runner-layer { 
            display: none; position: fixed; 
            inset: 0; /* å¼ºåˆ¶å¡«æ»¡ï¼ŒåŒ…æ‹¬åº•éƒ¨ä¸æ˜¾ç¤ºåŒºåŸŸ */
            background: #fff; z-index: 100; 
        }
        #runner-iframe { width: 100%; height: 100%; border: none; }
        
        #exit-fab {
            position: absolute; 
            top: calc(15px + env(safe-area-inset-top)); 
            right: 20px;
            width: 36px; height: 36px; background: rgba(0,0,0,0.5); border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center; 
            z-index: 101; font-size: 18px; backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <div id="app-ui">
        <div class="header">
            <h1 id="app-title">TNAA_SANDBOX</h1>
            <button id="nav-btn-new" class="btn-new" onclick="actionNew()">+ NEW</button>
        </div>
        <div id="file-list"></div>
    </div>

    <div id="editor-layer">
        <div class="editor-bar">
            <button class="btn-text btn-cancel" onclick="uiCloseEditor()">CLOSE</button>
            <span id="editor-title" style="color:#555; font-size:11px; line-height:30px;">EDITOR</span>
            <button id="nav-btn-save" class="btn-text" onclick="actionSave()">SAVE & RUN</button>
        </div>
        <textarea id="code-area" spellcheck="false" autocorrect="off" autocapitalize="off" autocomplete="off"></textarea>
    </div>

    <div id="runner-layer">
        <div id="exit-fab" onclick="uiCloseRunner()">âœ•</div>
        <iframe id="runner-iframe"></iframe>
    </div>

<script>
    /* --- æ•°æ®ä¸åˆå§‹åŒ– --- */
    const DB_KEY = 'tnaa_vfs_v1';
    let projects = [];
    try {
        projects = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
    } catch(e) { projects = []; }
    
    let activeId = null;
    let currentBlobUrl = null;

    const domList = document.getElementById('file-list');
    const domEditor = document.getElementById('editor-layer');
    const domCode = document.getElementById('code-area');
    const domRunner = document.getElementById('runner-layer');
    const domIframe = document.getElementById('runner-iframe');

    // ç¦»çº¿çŠ¶æ€æ£€æµ‹
    function isOffline() {
        if (!navigator.onLine) {
            alert("OFFLINE MODE: Changes cannot be saved.");
            return true;
        }
        return false;
    }

    function updateOnlineUI() {
        const title = document.getElementById('app-title');
        const btnNew = document.getElementById('nav-btn-new');
        const btnSave = document.getElementById('nav-btn-save');
        
        if (!navigator.onLine) {
            title.innerText = "TNAA_OFFLINE";
            title.style.color = "#444";
            btnNew.disabled = true;
            btnSave.disabled = true;
        } else {
            title.innerText = "TNAA_SANDBOX";
            title.style.color = "#0f0";
            btnNew.disabled = false;
            btnSave.disabled = false;
        }
    }

    function dbSave() {
        localStorage.setItem(DB_KEY, JSON.stringify(projects));
        renderList();
    }

    function renderList() {
        domList.innerHTML = '';
        projects.forEach(p => {
            const row = document.createElement('div');
            row.className = 'file-row';
            row.innerHTML = `
                <div class="file-name" onclick="actionRun('${p.id}')">ğŸ“„ ${escapeHtml(p.name)}</div>
                <div class="file-actions">
                    <button onclick="uiOpenEditor('${p.id}')">EDIT</button>
                    <button class="btn-del" onclick="actionDelete('${p.id}', event)">DEL</button>
                </div>
            `;
            domList.appendChild(row);
        });
    }

    /* --- äº¤äº’é€»è¾‘ --- */
    function actionNew() {
        if (isOffline()) return;
        const name = prompt("File Name:", "index.html");
        if (!name) return;
        const newProj = {
            id: 'id_' + Date.now(),
            name: name,
            code: '<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="utf-8">\n  <title>New Page</title>\n  <style>\n    body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }\n    h1 { border-bottom: 1px solid #333; }\n  </style>\n</head>\n<body>\n  <h1>HELLO WORLD</h1>\n  <p>Sandbox is ready.</p>\n</body>\n</html>'
        };
        projects.unshift(newProj);
        dbSave();
    }

    function uiOpenEditor(id) {
        const p = projects.find(x => x.id === id);
        if (!p) return;
        activeId = id;
        document.getElementById('editor-title').innerText = p.name.toUpperCase();
        domCode.value = p.code;
        domEditor.style.display = 'flex';
    }

    function actionSave() {
        if (isOffline()) return;
        const idx = projects.findIndex(x => x.id === activeId);
        if (idx !== -1) {
            projects[idx].code = domCode.value;
            dbSave();
            actionRun(activeId); 
        }
    }

    function actionDelete(id, e) {
        if (isOffline()) return;
        if(e) e.stopPropagation();
        if (confirm("DELETE THIS FILE?")) {
            projects = projects.filter(x => x.id !== id);
            dbSave();
        }
    }

    function actionRun(id) {
        const p = projects.find(x => x.id === id);
        if (!p) return;
        if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);

        domRunner.style.display = 'block';
        
        // è‡ªåŠ¨æ³¨å…¥ç§»åŠ¨ç«¯é€‚é…è¡¥ä¸
        const patch = `<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><style>html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;}</style>`;
        let fullCode = p.code;
        fullCode = /<head>/i.test(fullCode) ? fullCode.replace(/<head>/i, '<head>' + patch) : patch + fullCode;

        const blob = new Blob([fullCode], { type: 'text/html' });
        currentBlobUrl = URL.createObjectURL(blob);
        domIframe.src = currentBlobUrl;
    }

    function uiCloseEditor() { domEditor.style.display = 'none'; domCode.blur(); }
    function uiCloseRunner() { 
        domRunner.style.display = 'none'; 
        domIframe.src = 'about:blank';
        if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
    }

    // ç¼–è¾‘å™¨è¾…åŠ©ï¼šTab é”®ç¼©è¿›
    domCode.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 2;
        }
    });

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // æ³¨å†Œ Service Worker (ç¦»çº¿æ”¯æŒ)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
    }

    window.addEventListener('online', updateOnlineUI);
    window.addEventListener('offline', updateOnlineUI);
    
    // åˆå§‹åŒ–æ¸²æŸ“
    renderList();
    updateOnlineUI();

    // å½»åº•ä¿®å¤ iOS æ©¡çš®ç­‹å¹²æ‰°
    document.addEventListener('touchmove', (e) => {
        const isScrollable = e.target.closest('#file-list') || e.target === domCode;
        if (!isScrollable) e.preventDefault();
    }, { passive: false });
</script>
</body>
</html>