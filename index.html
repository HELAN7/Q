<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover" />
<title>反应测试</title>
<style>
  :root {
    font-family: system-ui, -apple-system, sans-serif;
    --bg-color: #d32f2f; /* 动态背景变量 */
  }

  /* 核心修复：彻底锁定 html 和 body，防止露出底层白色 */
  html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: var(--bg-color);
    position: fixed; /* 锁定视口 */
  }

  /* 欺骗层：稍微比视口大一点点，强制背景填充 */
  .screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    /* 使用 dvh (Dynamic Viewport Height) 适配 Safari 动态工具栏 */
    height: 100vh;
    height: 100dvh; 
    background-color: var(--bg-color);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    -webkit-user-select: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
    z-index: 1;
  }

  /* 修复底部的缝隙，强制向下拉伸 100 像素确保覆盖 */
  .screen::after {
    content: "";
    position: absolute;
    bottom: -100px;
    left: 0;
    right: 0;
    height: 100px;
    background-color: inherit;
  }

  .text {
    font-size: 6.5vw; 
    line-height: 1.15;
    color: white;
    white-space: pre-line;
    z-index: 2;
  }

  .data-panel {
    position: fixed;
    /* 适配刘海屏底部安全区域 */
    bottom: calc(15px + env(safe-area-inset-bottom));
    width: 46%;
    max-index: 10;
    pointer-events: none;
    font-family: inherit;
    box-sizing: border-box;
    padding: 6px 10px;
    z-index: 3;
  }
  .left-panel { left: 6px; text-align: left; }
  .right-panel { right: 6px; text-align: right; }

  .list { display: flex; flex-direction: column-reverse; gap: 6px; }
  .item {
    font-size: 4.5vw;
    line-height: 1;
    color: rgba(255,255,255,0.95);
    text-shadow: 0 1px 2px rgba(0,0,0,0.55);
  }
  .item.current { color: #7CFC00; }
  .item.empty { color: rgba(255,255,255,0.4); }

  @media (min-width: 420px) { .text { font-size: 28px; } .item { font-size: 18px; } }
</style>
</head>
<body>

<div id="screen" class="screen">
  <div id="text" class="text">加载中...</div>
</div>

<div class="data-panel left-panel">
  <div id="singles" class="list">
    <div class="item empty">—</div><div class="item empty">—</div><div class="item empty current">—</div>
  </div>
</div>

<div class="data-panel right-panel">
  <div id="avgs" class="list">
    <div class="item empty">—</div><div class="item empty">—</div><div class="item empty current">—</div>
  </div>
</div>

<script>
(function(){
  const screen = document.getElementById('screen');
  const textEl = document.getElementById('text');
  const singlesListEl = document.getElementById('singles');
  const avgListEl = document.getElementById('avgs');

  const COLORS = { RED: '#d32f2f', GREEN: '#2e7d32', BLUE: '#1976d2' };
  let state = 'idle', timeoutId = null, readyTs = 0;
  const results = [], batchAverages = [];
  let currentBatch = [];

  // 关键修复：同步修改全局 CSS 变量
  function setColor(col){
    document.documentElement.style.setProperty('--bg-color', col);
  }

  function setText(txt){ textEl.textContent = txt; }

  function toIdle(){
    clearPending();
    state = 'idle';
    setColor(COLORS.RED);
    setText('当屏幕变为绿色时点击屏幕\n点击即开始');
  }

  function clearPending(){
    if(timeoutId!==null){ clearTimeout(timeoutId); timeoutId = null; }
    readyTs = 0;
  }

  function startWaiting(){
    state = 'waiting';
    setColor(COLORS.RED);
    setText('等待中…\n请准备');
    const delay = 1200 + Math.floor(Math.random()*3000);
    timeoutId = setTimeout(() => {
      timeoutId = null;
      becomeReady();
    }, delay);
  }

  function becomeReady(){
    state = 'ready';
    setColor(COLORS.GREEN);
    readyTs = performance.now();
    setText('点击！');
  }

  function showResultMessage(msg){
    state = 'result';
    setColor(COLORS.BLUE);
    setText(msg + '\n\n点击屏幕重新开始');
  }

  function updateSinglesDisplay() {
    const items = singlesListEl.querySelectorAll('.item');
    const lastThree = results.slice(-3);
    for (let i = 0; i < 3; i++) {
      const el = items[i];
      const value = lastThree[lastThree.length - 1 - i];
      if (value === undefined) {
        el.textContent = '—';
        el.classList.add('empty');
      } else {
        el.textContent = value + ' ms';
        el.classList.remove('empty');
        el.classList.toggle('current', i === 0);
      }
    }
  }

  function updateAveragesDisplay() {
    const items = avgListEl.querySelectorAll('.item');
    const lastThreeAvg = batchAverages.slice(-3);
    for (let i = 0; i < 3; i++) {
      const el = items[i];
      const value = lastThreeAvg[lastThreeAvg.length - 1 - i];
      if (value === undefined) {
        el.textContent = '—';
        el.classList.add('empty');
      } else {
        el.textContent = value + ' ms';
        el.classList.remove('empty');
        el.classList.toggle('current', i === 0);
      }
    }
  }

  function recordResult(ms) {
    results.push(ms);
    currentBatch.push(ms);
    if (currentBatch.length === 5) {
      const avg = Math.round(currentBatch.reduce((a,b)=>a+b,0) / 5);
      batchAverages.push(avg);
      currentBatch = [];
    }
    updateSinglesDisplay();
    updateAveragesDisplay();
  }

  function onPointerDown(e){
    e.preventDefault();
    // 强制触发全屏尝试（针对 Safari 即使不添加到主屏幕）
    if (document.documentElement.requestFullscreen) {
       document.documentElement.requestFullscreen();
    }

    if(state === 'idle'){ startWaiting(); return; }
    if(state === 'waiting'){
      clearPending();
      showResultMessage('太早了！');
      return;
    }
    if(state === 'ready'){
      const dt = Math.round(performance.now() - readyTs);
      showResultMessage('反应时间: ' + dt + ' ms');
      recordResult(dt);
      return;
    }
    if(state === 'result'){ startWaiting(); return; }
  }

  // 核心修复：阻止所有可能导致“露出红底”的默认滚动行为
  document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

  screen.addEventListener('pointerdown', onPointerDown);
  
  // 页面加载后自动尝试隐藏地址栏
  window.addEventListener('load', () => {
    setTimeout(() => {
      window.scrollTo(0, 1);
      toIdle();
    }, 300);
  });

})();
</script>
</body>
</html>