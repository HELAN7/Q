<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TNAA Pro">
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            width: 100%;
            /* å…³é”®ä¿®å¤ï¼šä½¿ç”¨ dvh ç¡®ä¿åœ¨ä»»ä½•æ—¶åˆ»é«˜åº¦éƒ½ç²¾å‡†åŒ¹é…ç‰©ç†å±å¹• */
            height: 100dvh; 
            background-color: #000; /* ç¡®ä¿èƒŒæ™¯è‰²è¦†ç›–çŠ¶æ€æ åŒºåŸŸ */
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            position: fixed;
        }

        #app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            /* å…³é”®ä¿®å¤ï¼šé¡¶éƒ¨å¢åŠ å®‰å…¨åŒº paddingï¼Œé˜²æ­¢ä¸æ—¶é—´ç”µé‡é‡å  */
            padding-top: env(safe-area-inset-top);
            /* åº•éƒ¨å¢åŠ å®‰å…¨åŒº paddingï¼Œé˜²æ­¢è¢« Home æ¡é®æŒ¡ */
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #222;
        }
        
        .header h1 { margin: 0; font-size: 18px; color: #0f0; letter-spacing: 1px; }

        #file-list { 
            flex: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }

        .file-row {
            padding: 18px 20px;
            border-bottom: 1px solid #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-new {
            background: #0f0; color: #000; border: none;
            padding: 6px 12px; border-radius: 4px; font-weight: bold; font-size: 12px;
        }

        /* ç¼–è¾‘å™¨å±‚ */
        #editor-layer {
            display: none; position: fixed; inset: 0; background: #000; z-index: 50;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        textarea#code-area {
            flex: 1; width: 100%; border: none; background: #080808; color: #0f0;
            padding: 15px; font-family: "SF Mono", monospace; font-size: 14px; outline: none;
        }

        /* è¿è¡Œå±‚ */
        #runner-layer { display: none; position: fixed; inset: 0; background: #fff; z-index: 100; }
        #runner-iframe { width: 100%; height: 100%; border: none; }
        
        #exit-fab {
            position: absolute; top: calc(10px + env(safe-area-inset-top)); right: 15px;
            width: 34px; height: 34px; background: rgba(0,0,0,0.5); border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            z-index: 101; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <div class="header">
            <h1>TNAA_SANDBOX</h1>
            <button class="btn-new" onclick="actionNew()">+ NEW</button>
        </div>
        <div id="file-list"></div>
    </div>

    <div id="editor-layer">
        <div style="padding: 10px 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #222;">
            <button onclick="uiCloseEditor()" style="background:none; border:none; color:#ff3b30; font-weight:bold;">CLOSE</button>
            <button onclick="actionSave()" style="background:none; border:none; color:#0f0; font-weight:bold;">SAVE & RUN</button>
        </div>
        <textarea id="code-area" spellcheck="false"></textarea>
    </div>

    <div id="runner-layer">
        <div id="exit-fab" onclick="uiCloseRunner()">âœ•</div>
        <iframe id="runner-iframe"></iframe>
    </div>

<script>
    /* ä½¿ç”¨ä¹‹å‰ä½ æœ€æ»¡æ„çš„ JS é€»è¾‘å³å¯ï¼Œç¡®ä¿åœ¨ actionRun æ—¶ä¹Ÿä½¿ç”¨äº† patch æ³¨å…¥æ ·å¼ */
    const DB_KEY = 'tnaa_vfs_v1';
    let projects = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
    let activeId = null;

    const domList = document.getElementById('file-list');
    const domEditor = document.getElementById('editor-layer');
    const domCode = document.getElementById('code-area');
    const domRunner = document.getElementById('runner-layer');
    const domIframe = document.getElementById('runner-iframe');

    function renderList() {
        domList.innerHTML = '';
        projects.forEach(p => {
            const row = document.createElement('div');
            row.className = 'file-row';
            row.innerHTML = `
                <div style="flex:1" onclick="actionRun('${p.id}')">ğŸ“„ ${p.name}</div>
                <button onclick="uiOpenEditor('${p.id}')" style="background:none; border:1px solid #333; color:#888; padding:4px 8px; border-radius:4px; font-size:11px;">EDIT</button>
            `;
            domList.appendChild(row);
        });
    }

    function actionNew() {
        const name = prompt("Name:", "index.html");
        if (!name) return;
        projects.unshift({ id: 'id_'+Date.now(), name, code: '<h1>Hello</h1>' });
        localStorage.setItem(DB_KEY, JSON.stringify(projects));
        renderList();
    }

    function uiOpenEditor(id) {
        activeId = id;
        domCode.value = projects.find(x => x.id === id).code;
        domEditor.style.display = 'flex';
    }

    function actionSave() {
        const idx = projects.findIndex(x => x.id === activeId);
        projects[idx].code = domCode.value;
        localStorage.setItem(DB_KEY, JSON.stringify(projects));
        actionRun(activeId);
    }

    function actionRun(id) {
        const p = projects.find(x => x.id === id);
        domRunner.style.display = 'block';
        // å…³é”®ï¼šæ³¨å…¥ Patch ç¡®ä¿é¢„è§ˆé¡µä¹Ÿé€‚é… Safe Area
        const patch = `<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><style>body{margin:0; background:#000; color:#fff; padding-top:env(safe-area-inset-top);}</style>`;
        const blob = new Blob([patch + p.code], { type: 'text/html' });
        domIframe.src = URL.createObjectURL(blob);
    }

    function uiCloseEditor() { domEditor.style.display = 'none'; }
    function uiCloseRunner() { domRunner.style.display = 'none'; domIframe.src = 'about:blank'; }

    renderList();
</script>
</body>
</html>