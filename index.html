<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover" />
<title>反应测试</title>
<style>
  :root { --bg: #d32f2f; }

  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background-color: var(--bg);
    /* 强制锁定物理视口，不给系统留任何间隙 */
    position: fixed;
  }

  #screen {
    /* 关键：使用 fixed 绝对定位，完全无视系统布局建议 */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    /* 强制高度超过物理屏幕，确保完全覆盖底部的 Home 条区域 */
    height: 120vh; 
    background-color: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
    /* 取消点击高亮 */
    -webkit-tap-highlight-color: transparent;
  }

  .text {
    font-size: 6.5vw;
    color: white;
    text-align: center;
    white-space: pre-line;
    user-select: none;
    /* 修正因为 120vh 导致的视觉重心偏移 */
    transform: translateY(-10vh); 
  }

  /* 数据面板：改用物理像素定位，避开 env(safe-area) 的干扰 */
  .data-panel {
    position: fixed;
    bottom: 30px; /* 稍微调高，确保在全屏下不被横条物理遮挡 */
    width: 45%;
    z-index: 10;
    pointer-events: none;
  }
  .left-panel { left: 10px; text-align: left; }
  .right-panel { right: 10px; text-align: right; }

  .item { font-size: 18px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin-bottom: 5px; }
  .item.current { color: #7CFC00; font-weight: bold; }
  .item.empty { opacity: 0.4; }
</style>
</head>
<body>

<div id="screen">
  <div id="text" class="text">点击开始</div>
</div>

<div class="data-panel left-panel">
  <div id="singles">
    <div class="item empty">—</div><div class="item empty">—</div><div class="item empty current">—</div>
  </div>
</div>

<div class="data-panel right-panel">
  <div id="avgs">
    <div class="item empty">—</div><div class="item empty">—</div><div class="item empty current">—</div>
  </div>
</div>

<script>
(function(){
  const screen = document.getElementById('screen');
  const textEl = document.getElementById('text');
  const sList = document.getElementById('singles').children;
  const aList = document.getElementById('avgs').children;

  const COLORS = { RED: '#d32f2f', GREEN: '#2e7d32', BLUE: '#1976d2' };
  let state = 'idle', timeoutId = null, readyTs = 0;
  const results = [], batchAverages = [];
  let currentBatch = [];

  function setColor(col){
    document.documentElement.style.setProperty('--bg', col);
    // 强制触发重绘，防止 iOS 渲染延迟
    screen.style.backgroundColor = col;
  }

  function startWaiting(){
    state = 'waiting';
    setColor(COLORS.RED);
    textEl.textContent = '等待中…\n请准备';
    timeoutId = setTimeout(() => {
      state = 'ready';
      setColor(COLORS.GREEN);
      readyTs = performance.now();
      textEl.textContent = '点击！';
    }, 1200 + Math.random() * 3000);
  }

  function handleAction(e){
    e.preventDefault();
    if(state === 'idle' || state === 'result') { startWaiting(); }
    else if(state === 'waiting') {
      clearTimeout(timeoutId);
      state = 'result';
      setColor(COLORS.BLUE);
      textEl.textContent = '太早了！\n\n点击重新开始';
    }
    else if(state === 'ready') {
      const dt = Math.round(performance.now() - readyTs);
      state = 'result';
      setColor(COLORS.BLUE);
      textEl.textContent = '反应时间: ' + dt + ' ms\n\n点击重新开始';
      
      // 更新逻辑
      results.push(dt);
      currentBatch.push(dt);
      if (currentBatch.length === 5) {
        batchAverages.push(Math.round(currentBatch.reduce((a,b)=>a+b,0)/5));
        currentBatch = [];
      }
      updateUI();
    }
  }

  function updateUI() {
    const lastS = results.slice(-3);
    const lastA = batchAverages.slice(-3);
    for(let i=0; i<3; i++) {
      const sVal = lastS[lastS.length-1-i];
      sList[i].textContent = sVal ? sVal + ' ms' : '—';
      sList[i].className = sVal ? (i===0 ? 'item current' : 'item') : 'item empty';
      
      const aVal = lastA[lastA.length-1-i];
      aList[i].textContent = aVal ? aVal + ' ms' : '—';
      aList[i].className = aVal ? (i===0 ? 'item current' : 'item') : 'item empty';
    }
  }

  // 关键：监听 touchstart 以获得最高优先级的全屏点击响应
  screen.addEventListener('touchstart', handleAction, { passive: false });
  // 禁止所有滚动行为
  document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });

  setColor(COLORS.RED);
  textEl.textContent = '当屏幕变为绿色时点击屏幕\n点击即开始';
})();
</script>
</body>
</html>